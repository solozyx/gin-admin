
{
    "Code": 0,
    "Msg": "SUCCESS",
    "Data": {
        "AccessToken": "eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL216LnRlc3Qub2JlbmNuLmNvbSIsImV4cCI6MTU5NTMxNDA3OCwibmJmIjoxNTk1MjI3Mzc4LCJpYXQiOjE1OTUyMjc2NzgsImp0aSI6ImQ5YWFjNDBmLTc3NjAtNGQ5ZS04ZjVhLTk1ZTJlMDM3ZDM3YSIsInVzZXJpZCI6MjcyfQ.GKkDHgzykAfIdBR83L5DZJYfRQUSu8J9fs6GPROdv00",
        "RefreshToken": "eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiUmVmcmVzaFRva2VuIiwiYXVkIjoiaHR0cHM6Ly9tei50ZXN0Lm9iZW5jbi5jb20iLCJleHAiOjE1OTc4MTk2NzgsIm5iZiI6MTU5NTIyNzM3OCwiaWF0IjoxNTk1MjI3Njc4LCJqdGkiOiI2MmRjYzRlOC0xNDBiLTQ1ZWMtYTNlMi05MzE1MTM3MjY5MDgiLCJ1c2VyaWQiOjI3Mn0.q5rqqGbukeDx1RpdRlJQlNt8vVAQ-B_0WC9o1dUnJsY",
        "UserInfo": {
            "HaveLikes": 1,
            "HeadImg": "",
            "Mzid": "MZ15791419275ngD",
            "Nickname": "MZ_gkTp",
            "Phone": "18813141886",
            "QQ": "",
            "Sex": "secret",
            "Vip": 0,
            "VipExpire": "1970-01-01T00:00:00+08:00",
            "WeChat": ""
        }
    }
}

CREATE TABLE `mz_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `phonenum` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '手机号',
  `wechat` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '微信',
  `qq` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'QQ号',
  `apple_id` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '',
  `gender` int(11) NOT NULL COMMENT '性别 "1"是男，"2"是女',
  `deviceCode` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '设备码',
  `useraddress` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '地址',
  `Image` varchar(32) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '形象照',
  `updatetime` datetime NOT NULL COMMENT '更新时间',
  `mzid` varchar(32) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '秒追ID',
  `versionum` varchar(32) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '版本号',
  `devicetype` varchar(32) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '手机型号 android / ios',
  `invitcode` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '邀请码',
  `pid` int(11) NOT NULL COMMENT '父ID',
  `vip` int(11) NOT NULL DEFAULT '0' COMMENT '会员标识 二进制 0x0001:月会员 0x0010:季会员 0x0100:年会员 0x1000:试用会员 0x0000:非会员',
  `vipExpire` datetime NOT NULL DEFAULT '1970-01-01 00:00:00',
  `createtime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `status` enum('normal','disable') COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'normal',
  `balance` int(10) unsigned NOT NULL DEFAULT '0',
  `version` int(10) unsigned NOT NULL DEFAULT '0',
  `channel_id` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `mz_user_phonenum_index` (`phonenum`),
  KEY `mz_user_wechat_index` (`wechat`),
  KEY `mz_user_qq_index` (`qq`),
  KEY `mz_user_mzid_index` (`mzid`),
  KEY `sindex` (`balance`,`version`)
) ENGINE=InnoDB AUTO_INCREMENT=642 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';


mysql> select * from mz_user where phonenum='18813141886'\G
*************************** 1. row ***************************
         id: 272
   phonenum: 18813141886
     wechat:
         qq:
   apple_id:
     gender: 0
 deviceCode: niuivfdehfbuco
useraddress:
      Image:
 updatetime: 2020-07-20 14:47:58
       mzid: MZ15791419275ngD
  versionum:
 devicetype: Android
  invitcode:
        pid: 0
        vip: 0
  vipExpire: 1970-01-01 00:00:00
 createtime: 2020-03-01 10:32:08
     status: normal
    balance: 804
    version: 1
 channel_id: 0
1 row in set (0.00 sec)
mysql>


hset lottery:remain:userid_0 272 1000
hget lottery:remain:userid_0 272

172.17.132.191:7001> hset lottery:remain:userid_0 272 1000
(integer) 1
172.17.132.191:7001> hget lottery:remain:userid_0 272
"1000"
172.17.132.191:7001>



{
    "Code": 0,
    "Msg": "SUCCESS",
    "Data": {
        "PrizeId": 2,
        "PrizeName": "iPhone 11 Pro",
        "ImageUrl": "https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png",
        "LeftNum": 999,
        "ReceiveId": "SN1595229402451566147idwqTy",
        "PrizeLevel": 2
    }
}


2020/7/20 下午2:17:02{"level":"info","msg":"开启订阅协程 No. 14","source":"proc.go:203:runtime.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"info","msg":"开启订阅协程 No. 15","source":"proc.go:203:runtime.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"get prizes from Redis list=[{ID:1 Name:特斯拉 Model3 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3.png ImageUrl2:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3blue.png ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/model3prize.png PrizeStatus:1 Quantity:10 Level:1 Sort:1} {ID:5 Name:一套医用口罩 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/kouzhao.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/kouzhaoprize.png PrizeStatus:1 Quantity:0 Level:5 Sort:2} {ID:2 Name:iPhone 11 Pro ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/iphone.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png PrizeStatus:1 Quantity:200 Level:2 Sort:3} {ID:7 Name:谢谢参与 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/henyihan.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:7 Sort:4} {ID:6 Name:再来一次 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/zailaiyici.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:6 Sort:5} {ID:3 Name:小米手环4 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/xiaomi.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/xiaomiprize.png PrizeStatus:1 Quantity:1000 Level:3 Sort:6} {ID:4 Name:秒追定制礼盒 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/lihe.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/liheprize.png PrizeStatus:1 Quantity:0 Level:4 Sort:7}]","source":"lucky.go:46:service.InitPrizeList","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"Lucky InitPrizeList 获取奖品list=[{ID:1 Name:特斯拉 Model3 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3.png ImageUrl2:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3blue.png ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/model3prize.png PrizeStatus:1 Quantity:10 Level:1 Sort:1} {ID:5 Name:一套医用口罩 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/kouzhao.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/kouzhaoprize.png PrizeStatus:1 Quantity:0 Level:5 Sort:2} {ID:2 Name:iPhone 11 Pro ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/iphone.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png PrizeStatus:1 Quantity:200 Level:2 Sort:3} {ID:7 Name:谢谢参与 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/henyihan.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:7 Sort:4} {ID:6 Name:再来一次 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/zailaiyici.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:6 Sort:5} {ID:3 Name:小米手环4 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/xiaomi.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/xiaomiprize.png PrizeStatus:1 Quantity:1000 Level:3 Sort:6} {ID:4 Name:秒追定制礼盒 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/lihe.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/liheprize.png PrizeStatus:1 Quantity:0 Level:4 Sort:7}]","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"Lucky InitPrizeList 获取奖品prizeInitList=map[1:{1 特斯拉 Model3 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3.png https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3blue.png https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/model3prize.png 1 10 1 1} 2:{2 iPhone 11 Pro https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/iphone.png  https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png 1 200 2 3} 3:{3 小米手环4 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/xiaomi.png  https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/xiaomiprize.png 1 1000 3 6} 4:{4 秒追定制礼盒 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/lihe.png  https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/liheprize.png 1 0 4 7} 5:{5 一套医用口罩 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/kouzhao.png  https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/kouzhaoprize.png 1 0 5 2} 6:{6 再来一次 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/zailaiyici.png   1 0 6 5} 7:{7 谢谢参与 https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/henyihan.png   1 0 7 4}]","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"Lucky InitPrizeList ------------------","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"tsl={ID:1 Name:特斯拉 Model3 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3.png ImageUrl2:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/model3blue.png ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/model3prize.png PrizeStatus:1 Quantity:10 Level:1 Sort:1}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"iphone={ID:2 Name:iPhone 11 Pro ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/iphone.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png PrizeStatus:1 Quantity:200 Level:2 Sort:3}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"miBand={ID:3 Name:小米手环4 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/xiaomi.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/xiaomiprize.png PrizeStatus:1 Quantity:1000 Level:3 Sort:6}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"little={ID:4 Name:秒追定制礼盒 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/lihe.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/liheprize.png PrizeStatus:1 Quantity:0 Level:4 Sort:7}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"mask={ID:5 Name:一套医用口罩 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/kouzhao.png ImageUrl2: ImagePrizeUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/kouzhaoprize.png PrizeStatus:1 Quantity:0 Level:5 Sort:2}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"again={ID:6 Name:再来一次 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/zailaiyici.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:6 Sort:5}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"thank={ID:7 Name:谢谢参与 ImageUrl:https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/henyihan.png ImageUrl2: ImagePrizeUrl: PrizeStatus:1 Quantity:0 Level:7 Sort:4}","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}
2020/7/20 下午2:17:02{"level":"debug","msg":"Lucky InitPrizeList ------------------","source":"main.go:46:main.main","time":"2020-07-20T14:17:02+08:00"}



2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 收到请求消息. lotteryservice.lucky _INBOX.jtgMicw6jTulspyjUQb4NY.vjHx2vez {272 {} [] 0}","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"GetUserRemain from Redis userId=272 remain=1000","source":"lucky.go:136:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"SetLockLotteryUser 设置redis分布式锁key=lottery:lock:user:272 success","source":"lucky.go:154:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"error","msg":"updatePowerAgainRemain 用户剩余抽奖次数不足","source":"asm_amd64.s:1357:runtime.goexit","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountDistinctUser len(userIds)=100000","source":"lottery_repo.go:77:repository.(*mzLotteryRepo).GetLotteryTotalUsers","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountUserJoinTimesByUserId userId=272 count=25","source":"lottery_repo.go:202:repository.(*mzLotteryRepo).GetUserJoin","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountWinPrizeByPrizeId prizeId=1 count=2","source":"lottery_repo.go:212:repository.(*mzLotteryRepo).CountWinPrize","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountWinPrizeByPrizeId prizeId=2 count=15","source":"lottery_repo.go:212:repository.(*mzLotteryRepo).CountWinPrize","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountUserGainTimesByUserId userId=272 count=0","source":"lottery_repo.go:207:repository.(*mzLotteryRepo).GetUserGain","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 进入抽奖流程 userJoinTimes=25","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 进入抽奖流程 userGainTimes=0","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky lucky branch userJoinTimes 小于 50 并且 userJoinTimes 大于 20 lucky","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky lucky tslCount=2 iphoneCount=15 totalUsers=100000 userId=272","source":"lucky.go:265:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"GetPrizeStep from Redis key=lottery:step:iphone num=15","source":"lottery_repo.go:399:repository.(*mzLotteryRepo).LockTslOrIphone","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"IncrPrizeStep 成功 key=lottery:step:iphone num=1","source":"lottery_repo.go:422:repository.(*mzLotteryRepo).LockTslOrIphone","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky lucky branch19 prizeId=2","source":"lucky.go:265:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"IsUserWinTslOrIphone 用户未中特斯拉或iPhone","source":"lucky.go:582:service.lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky lucky prizeId=2","source":"lucky.go:265:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"IsUserWinTslOrIphone 用户未中特斯拉或iPhone","source":"lucky.go:314:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 发奖 tslId 或 iphoneId 或 miBandId resp.Data.PrizeId=2","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"SetLockLotteryServerPrize 设置redis分布式锁key=lottery:lock:server:prize:2 success","source":"lucky.go:415:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"CountWinPrizeByPrizeId prizeId=2 count=15","source":"lottery_repo.go:212:repository.(*mzLotteryRepo).CountWinPrize","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 获取 特斯拉 iPhone 小米手环 写入用户奖品表成功","source":"value.go:460:reflect.Value.call","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"UnLockLotteryServerPrize 删除redis分布式锁key=lottery:lock:server:prize:2 success","source":"lucky.go:458:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"UnLockLotteryUser 删除redis分布式锁key=lottery:lock:user:272 success","source":"lucky.go:458:service.Lucky","time":"2020-07-20T15:16:42+08:00"}
2020/7/20 下午3:16:42{"level":"debug","msg":"Lucky 消息处理完成. lotteryservice.lucky _INBOX.jtgMicw6jTulspyjUQb4NY.vjHx2vez {0 SUCCESS PrizeId:2 PrizeName:\"iPhone 11 Pro\" ImageUrl:\"https://secondschased.oss-cn-beijing.aliyuncs.com/lottery/prize/iphoneprize.png\" LeftNum:999 ReceiveId:\"SN1595229402451566147idwqTy\" PrizeLevel:2  {} [] 144}","source":"lucky.go:458:service.Lucky","time":"2020-07-20T15:16:42+08:00"}


172.17.132.191:7001> get lottery:step:iphone
"16"
172.17.132.191:7001>
172.17.132.191:7001> get lottery:step:tsl
-> Redirected to slot [4537] located at 172.17.132.192:7001
"2"
172.17.132.192:7001>

