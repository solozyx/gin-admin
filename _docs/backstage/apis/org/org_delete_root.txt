
root
{
	"account_no":"root@email.com",
	"password":"asdf1234"
}
{
    "code": 0,
    "msg": "SUCCESS",
    "data": {
        "access_token": "eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL2JhY2tzdGFnZS5vYmVuY24uY29tIiwiZXhwIjoxNTkzODMzNDQ5LCJuYmYiOjE1OTM3NDY3NDksImlhdCI6MTU5Mzc0NzA0OSwianRpIjoiYmZlZmNhN2EtZmFhNy00NzAyLTg4NmQtNDAyNmFjNTJlYWU3IiwidXNlcl9pZCI6MX0.0lUSKjY8ybj0cpvOIYQx91lK_ri-yZRu-Aw-BdkY-ls",
        "refresh_token": "eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJiYWNrc3RhZ2UuZ2F0ZXdheSIsInN1YiI6IlJlZnJlc2hUb2tlbiIsImF1ZCI6Imh0dHBzOi8vYmFja3N0YWdlLm9iZW5jbi5jb20iLCJleHAiOjE1OTYzMzkwNDksIm5iZiI6MTU5Mzc0Njc0OSwiaWF0IjoxNTkzNzQ3MDQ5LCJqdGkiOiI0Mjg4NGU1OC1mNzRlLTQxZDEtYmEzMS1kMGM0OTYwM2FkZDciLCJ1c2VyX2lkIjoxfQ.fmeGYIcPiSv1ZmGTd_Gz1LyEeusw7hCBxN-9zGkutvM",
        "user_info": {
            "id": 1,
            "real_name": "总行行长",
            "email": "root@email.com",
            "phone": "18813141001",
            "creator_id": 0,
            "organization_id": 1,
            "department_id": 0,
            "org_name": "总行",
            "dep_name": "",
            "desc": "系统管理员",
            "created_at": "2020-05-12T14:58:40+08:00",
            "updated_at": "2020-07-02T18:07:05+08:00"
        }
    }
}


mysql> select * from bs_organization where id=3;
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
| id | name         | level | email | phone | org_status | creator_id | desc | created_at          | updated_at          |
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
|  3 | 上海分行     |     2 |       |       |          1 |          1 |      | 2020-07-02 18:15:12 | 2020-07-02 18:15:12 |
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
1 row in set (0.00 sec)
mysql>


{
    "code": 0,
    "msg": "SUCCESS",
    "data": {
        "id": 1,
        "name": "总行",
        "level": 1,
        "email": "zonghang@email.com",
        "phone": "18800000000",
        "org_status": 2,
        "creator_id": 1,
        "desc": "",
        "created_at": "2020-06-19T13:46:13+08:00",
        "updated_at": "2020-07-03T11:37:33.7530941+08:00"
    }
}


> use backstage
switched to db backstage
>
> show tables;
operate_log
verify_code
>
> db.operate_log.find().sort({_id:-1}).limit(1).pretty()
{
	"_id" : ObjectId("5efea7fd6adcd68254ea543a"),
	"user_id" : 1,
	"real_name" : "总行行长",
	"organization_id" : 1,
	"department_id" : 0,
	"operate" : "删除组织:总行",
	"path" : "/api/v1/org/delete",
	"method" : "POST",
	"ip" : "127.0.0.1",
	"hazard_level" : 2,
	"created_at" : "2020-07-03T11:37:33+08:00"
}
>
> db.operate_log.remove({"_id" : ObjectId("5efea7fd6adcd68254ea543a")})
WriteResult({ "nRemoved" : 1 })
>
> db.operate_log.find().sort({_id:-1}).limit(1).pretty()
{
	"_id" : ObjectId("5efea6696adcd68254ea5439"),
	"user_id" : 1,
	"real_name" : "总行行长",
	"organization_id" : 1,
	"department_id" : 0,
	"operate" : "登录系统",
	"path" : "/api/v1/mine/login",
	"method" : "POST",
	"ip" : "127.0.0.1",
	"hazard_level" : 0,
	"created_at" : "2020-07-03T11:30:49+08:00"
}
>


{
	"org_id":3
}
{
    "code": 0,
    "msg": "SUCCESS",
    "data": {
        "id": 3,
        "name": "上海分行",
        "level": 2,
        "email": "",
        "phone": "",
        "org_status": 2,
        "creator_id": 1,
        "desc": "",
        "created_at": "2020-07-02T18:15:12+08:00",
        "updated_at": "2020-07-03T13:43:40.2733812+08:00"
    }
}

{"level":"debug","msg":"sign before: POST127.0.0.1:9001/api/v1/org/delete{\"org_id\":3}1234567890com.obencn.backstage.c27d32c5-c878-470a-8a6f-107f7d3700dd","source":"head.go:116:middleware.Options","time":"2020-07-03T13:43:40+08:00"}
{"level":"debug","msg":"server sign: 6c390efe5bfa6d83852f27734d264be0, \tuser sign: 6c390efe5bfa6d83852f27734d264be0","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T13:43:40+08:00"}
{"level":"debug","msg":"request uri=/api/v1/org/delete JWT 验证token","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T13:43:40+08:00"}
{"level":"debug","msg":"request token=eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL2JhY2tzdGFnZS5vYmVuY24uY29tIiwiZXhwIjoxNTkzODMzNDQ5LCJuYmYiOjE1OTM3NDY3NDksImlhdCI6MTU5Mzc0NzA0OSwianRpIjoiYmZlZmNhN2EtZmFhNy00NzAyLTg4NmQtNDAyNmFjNTJlYWU3IiwidXNlcl9pZCI6MX0.0lUSKjY8ybj0cpvOIYQx91lK_ri-yZRu-Aw-BdkY-ls","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T13:43:40+08:00"}
{"level":"debug","msg":"request uri=/api/v1/org/delete middleware Casbin 验证权限","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T13:43:40+08:00"}
2020/07/03 13:43:40 Request: 1, /api/v1/org/delete, POST ---> true
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/organization.go:4122.9394msSELECT * FROM `bs_organization`  WHERE (id=?) ORDER BY `bs_organization`.`id` ASC LIMIT 1[3] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-03T13:43:40+08:00"}
{"level":"debug","msg":"orgRepo Delete org={ID:3 Name:上海分行 Level:2 Email: Phone: OrgStatus:1 CreatorId:1 Desc: CreatedAt:2020-07-02 18:15:12 +0800 CST UpdatedAt:2020-07-02 18:15:12 +0800 CST}","source":"org.go:67:service.(*orgService).Delete","time":"2020-07-03T13:43:40+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/organization.go:5118.9401msUPDATE `bs_organization` SET `name` = ?, `level` = ?, `email` = ?, `phone` = ?, `org_status` = ?, `creator_id` = ?, `desc` = ?, `created_at` = ?, `updated_at` = ?  WHERE `bs_organization`.`id` = ?[上海分行 2   2 1  2020-07-02 18:15:12 +0800 CST 2020-07-03 13:43:40.2733812 +0800 CST m=+116.265668601 3] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-03T13:43:40+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user.go:24319.0059msSELECT * FROM `bs_user`  WHERE (id=?) ORDER BY `bs_user`.`id` ASC LIMIT 1[1] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-03T13:43:40+08:00"}


> db.operate_log.find().sort({_id:-1}).limit(1).pretty()
{
	"_id" : ObjectId("5efec58c6adcd653585198f9"),
	"user_id" : 1,
	"real_name" : "总行行长",
	"organization_id" : 1,
	"department_id" : 0,
	"operate" : "删除组织:上海分行",
	"path" : "/api/v1/org/delete",
	"method" : "POST",
	"ip" : "127.0.0.1",
	"hazard_level" : 2,
	"created_at" : "2020-07-03T13:43:40+08:00"
}
>


mysql> select * from bs_organization where id=3;
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
| id | name         | level | email | phone | org_status | creator_id | desc | created_at          | updated_at          |
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
|  3 | 上海分行     |     2 |       |       |          2 |          1 |      | 2020-07-02 18:15:12 | 2020-07-03 13:43:40 |
+----+--------------+-------+-------+-------+------------+------------+------+---------------------+---------------------+
1 row in set (0.00 sec)
mysql>


{
	"org_id":1
}
{
    "code": 20122,
    "msg": "一级组织不允许删除; "
}


{"level":"debug","msg":"sign before: POST127.0.0.1:9001/api/v1/org/delete{\"org_id\":1}1234567890com.obencn.backstage.c27d32c5-c878-470a-8a6f-107f7d3700dd","source":"head.go:116:middleware.Options","time":"2020-07-03T14:01:09+08:00"}
{"level":"debug","msg":"server sign: 9b208902d276a238fadb2f186b51ce15, \tuser sign: 9b208902d276a238fadb2f186b51ce15","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T14:01:09+08:00"}
{"level":"debug","msg":"request uri=/api/v1/org/delete JWT 验证token","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T14:01:09+08:00"}
{"level":"debug","msg":"request token=eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL2JhY2tzdGFnZS5vYmVuY24uY29tIiwiZXhwIjoxNTkzODMzNDQ5LCJuYmYiOjE1OTM3NDY3NDksImlhdCI6MTU5Mzc0NzA0OSwianRpIjoiYmZlZmNhN2EtZmFhNy00NzAyLTg4NmQtNDAyNmFjNTJlYWU3IiwidXNlcl9pZCI6MX0.0lUSKjY8ybj0cpvOIYQx91lK_ri-yZRu-Aw-BdkY-ls","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T14:01:09+08:00"}
{"level":"debug","msg":"request uri=/api/v1/org/delete middleware Casbin 验证权限","source":"context.go:161:gin.(*Context).Next","time":"2020-07-03T14:01:09+08:00"}
2020/07/03 14:01:09 Request: 1, /api/v1/org/delete, POST ---> true
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/organization.go:4125.9305msSELECT * FROM `bs_organization`  WHERE (id=?) ORDER BY `bs_organization`.`id` ASC LIMIT 1[1] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-03T14:01:09+08:00"}
{"level":"debug","msg":"orgRepo Delete org={ID:1 Name:总行 Level:1 Email:zonghang@email.com Phone:18800000000 OrgStatus:1 CreatorId:1 Desc: CreatedAt:2020-06-19 13:46:13 +0800 CST UpdatedAt:2020-07-03 11:38:33 +0800 CST}","source":"org.go:67:service.(*orgService).Delete","time":"2020-07-03T14:01:09+08:00"}
{"level":"error","msg":"一级组织不允许删除; ","source":"casbin.go:61:middleware.CasbinVerifyUserPermission.func1","time":"2020-07-03T14:01:09+08:00"}



mysql> select * from bs_organization where id=1;
+----+--------+-------+--------------------+-------------+------------+------------+------+---------------------+---------------------+
| id | name   | level | email              | phone       | org_status | creator_id | desc | created_at          | updated_at          |
+----+--------+-------+--------------------+-------------+------------+------------+------+---------------------+---------------------+
|  1 | 总行   |     1 | zonghang@email.com | 18800000000 |          1 |          1 |      | 2020-06-19 13:46:13 | 2020-07-03 11:38:33 |
+----+--------+-------+--------------------+-------------+------------+------------+------+---------------------+---------------------+
1 row in set (0.00 sec)
mysql>

