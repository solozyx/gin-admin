
a7489da46fcfb5333182ac39a942103a
{
    "user_id":4,
    "role_ids":[6]
}

{
    "code": 0,
    "msg": "SUCCESS",
    "data": [
        6
    ]
}

mysql> select * from bs_user_role where user_id=4;
+----+---------+---------+--------+------------+---------------------+---------------------+
| id | user_id | role_id | status | creator_id | created_at          | updated_at          |
+----+---------+---------+--------+------------+---------------------+---------------------+
| 19 |       4 |       6 |      1 |          2 | 2020-07-10 15:21:48 | 2020-07-10 15:21:48 |
+----+---------+---------+--------+------------+---------------------+---------------------+
1 row in set (0.00 sec)

mysql> select * from bs_user_role where user_id=5;
Empty set (0.00 sec)

mysql>

> db.operate_log.find().sort({_id:-1}).limit(1).pretty()
{
	"_id" : ObjectId("5f08170b6adcd6712ce74a91"),
	"user_id" : 2,
	"real_name" : "北京分行行长",
	"organization_id" : 2,
	"department_id" : 0,
	"operate" : "给 北京分行成员1 配置角色:北京分行自有角色1",
	"path" : "/api/v1/user/roleadd",
	"method" : "POST",
	"ip" : "127.0.0.1",
	"hazard_level" : 0,
	"created_at" : "2020-07-10T15:21:47+08:00"
}
>

{"level":"debug","msg":"sign before: POST127.0.0.1:9001/api/v1/user/roleadd{\"role_ids\":[6],\"user_id\":4}1234567890com.obencn.backstage.c27d32c5-c878-470a-8a6f-107f7d3700dd","source":"head.go:116:middleware.Options","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"server sign: a7489da46fcfb5333182ac39a942103a, \tuser sign: a7489da46fcfb5333182ac39a942103a","source":"context.go:161:gin.(*Context).Next","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"request uri=/api/v1/user/roleadd JWT 验证token","source":"context.go:161:gin.(*Context).Next","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"request token=eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL2JhY2tzdGFnZS5vYmVuY24uY29tIiwiZXhwIjoxNTk0NDM4NTk0LCJuYmYiOjE1OTQzNTE4OTQsImlhdCI6MTU5NDM1MjE5NCwianRpIjoiYjk3YWFiYzMtNGZmYy00NDliLWFmMDQtMDExYjZjMGY5MDhkIiwidXNlcl9pZCI6Mn0.mU8AO_q94S0iSsjpYh9m6P2fGs8W124cC7tT4YVAHks","source":"context.go:161:gin.(*Context).Next","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"request uri=/api/v1/user/roleadd middleware Casbin 验证权限","source":"context.go:161:gin.(*Context).Next","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd req={HttpModel:{Path:/api/v1/user/roleadd Method:POST IP:127.0.0.1} UserId:4 RoleIds:[6]}","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
2020/07/10 15:21:47 Request: 2, /api/v1/user/roleadd, POST ---> true
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user.go:24829.9196msSELECT * FROM `bs_user`  WHERE (id=?) ORDER BY `bs_user`.`id` ASC LIMIT 1[4] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user.go:24824.9333msSELECT * FROM `bs_user`  WHERE (id=?) ORDER BY `bs_user`.`id` ASC LIMIT 1[2] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/role.go:5016.9534msSELECT * FROM `bs_role`  WHERE (role_status=? AND (organization_id=? OR organization_id=?))[1 0 2] 4","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd admin s.UserId=2 可用角色列表 mRoleIds=map[2:{} 4:{} 5:{} 6:{}]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd userId=4 可添加角色列表 mUserCanAddRoleIds=map[6:{}]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user_role.go:8019.9545msSELECT * FROM `bs_user_role`  WHERE (user_id=?)[4] 0","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd userId=4 已有角色列表 userRoles=[]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd userId=4 可用角色列表 userNormalRoles=[]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd userId=4 禁用角色列表 userDisabledRoles=[]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"userService RoleAdd userId=4 最终可添加角色列表 mUserCanAddRoleIds=map[6:{}]","source":"user.go:204:handler.(*userHandler).RoleAdd.func1","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user_role.go:6127.9221msINSERT INTO `bs_user_role` (`user_id`,`role_id`,`status`,`creator_id`,`created_at`,`updated_at`) VALUES (?,?,?,?,?,?)[4 6 1 2 2020-07-10 15:21:47.7792415 +0800 CST m=+96.021931201 2020-07-10 15:21:47.7882237 +0800 CST m=+96.030913401] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/role.go:10726.9375msSELECT * FROM `bs_role`  WHERE (id=?) ORDER BY `bs_role`.`id` ASC LIMIT 1[6] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/role.go:7033.9102msSELECT * FROM `bs_role`  WHERE (role_status=?)[1] 7","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/permission.go:8320.9423msSELECT * FROM `bs_permission`  WHERE (perm_status=?)[1] 21","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/role_permission.go:6318.9496msSELECT * FROM `bs_role_permission`  WHERE (status=?)[1] 27","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/org/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/org/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/dep/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/dep/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/user/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/user/disable,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/org/list,GET","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/org/deplist,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/user/list,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/role/list,GET","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/user/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,1,/api/v1/user/roleadd,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/user/list,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/dep/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/user/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/user/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/user/disable,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/org/list,GET","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/dep/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/org/deplist,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/role/list,GET","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/role/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/role/permadd,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,2,/api/v1/user/roleadd,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,15,/api/v1/dep/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,15,/api/v1/user/create,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadRolePolicy line=p,15,/api/v1/dep/delete,POST","source":"casbin_adapter.go:25:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user.go:37316.9517msSELECT * FROM `bs_user`  WHERE (user_status=?)[1] 13","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user_role.go:7022.938msSELECT * FROM `bs_user_role`  WHERE (status=?)[1] 3","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadUserPolicy line=g,1,1","source":"casbin_adapter.go:29:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadUserPolicy line=g,2,2","source":"casbin_adapter.go:29:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter loadUserPolicy line=g,4,6","source":"casbin_adapter.go:29:adapter.(*CasbinAdapter).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m=map[e:map[e:0xc000086600] g:map[g:0xc000086540] m:map[m:0xc0000866c0] p:map[p:0xc0000864e0] r:map[r:0xc000086480]]","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m[e][e]=\u0026{Key:e Value:some(where (p_eft == allow)) Tokens:[] Policy:[] RM:\u003cnil\u003e}","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m[g][g]=\u0026{Key:g Value:_, _ Tokens:[] Policy:[[1 1] [2 2] [4 6]] RM:0xc00008a4a0}","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m[m][m]=\u0026{Key:m Value:g(r_sub, p_sub) \u0026\u0026 keyMatch2(r_obj, p_obj) \u0026\u0026 r_act == p_act Tokens:[] Policy:[] RM:\u003cnil\u003e}","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m[p][p]=\u0026{Key:p Value:sub, obj, act Tokens:[p_sub p_obj p_act] Policy:[[1 /api/v1/org/create POST] [1 /api/v1/org/delete POST] [1 /api/v1/dep/create POST] [1 /api/v1/dep/delete POST] [1 /api/v1/user/create POST] [1 /api/v1/user/disable POST] [1 /api/v1/org/list GET] [1 /api/v1/org/deplist POST] [1 /api/v1/user/list POST] [1 /api/v1/role/list GET] [1 /api/v1/user/delete POST] [1 /api/v1/user/roleadd POST] [2 /api/v1/user/list POST] [2 /api/v1/dep/create POST] [2 /api/v1/user/create POST] [2 /api/v1/user/delete POST] [2 /api/v1/user/disable POST] [2 /api/v1/org/list GET] [2 /api/v1/dep/delete POST] [2 /api/v1/org/deplist POST] [2 /api/v1/role/list GET] [2 /api/v1/role/create POST] [2 /api/v1/role/permadd POST] [2 /api/v1/user/roleadd POST] [15 /api/v1/dep/create POST] [15 /api/v1/user/create POST] [15 /api/v1/dep/delete POST]] RM:\u003cnil\u003e}","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
{"level":"debug","msg":"CasbinAdapter LoadPolicy casbinModel.Model m[r][r]=\u0026{Key:r Value:sub, obj, act Tokens:[r_sub r_obj r_act] Policy:[] RM:\u003cnil\u003e}","source":"enforcer.go:247:v2.(*Enforcer).LoadPolicy","time":"2020-07-10T15:21:47+08:00"}
2020/07/10 15:21:47 Policy:
2020/07/10 15:21:47 p: sub, obj, act: [[1 /api/v1/org/create POST] [1 /api/v1/org/delete POST] [1 /api/v1/dep/create POST] [1 /api/v1/dep/delete POST] [1 /api/v1/user/create POST] [1 /api/v1/user/disable POST] [1 /api/v1/org/list GET] [1 /api/v1/org/deplist POST] [1 /api/v1/user/list POST] [1 /api/v1/role/list GET] [1 /api/v1/user/delete POST] [1 /api/v1/user/roleadd POST] [2 /api/v1/user/list POST] [2 /api/v1/dep/create POST] [2 /api/v1/user/create POST] [2 /api/v1/user/delete POST] [2 /api/v1/user/disable POST] [2 /api/v1/org/list GET] [2 /api/v1/dep/delete POST] [2 /api/v1/org/deplist POST] [2 /api/v1/role/list GET] [2 /api/v1/role/create POST] [2 /api/v1/role/permadd POST] [2 /api/v1/user/roleadd POST] [15 /api/v1/dep/create POST] [15 /api/v1/user/create POST] [15 /api/v1/dep/delete POST]]
2020/07/10 15:21:47 g: _, _: [[1 1] [2 2] [4 6]]
2020/07/10 15:21:47 Role links for: g
2020/07/10 15:21:47 1 < 1, 2 < 2, 4 < 6

