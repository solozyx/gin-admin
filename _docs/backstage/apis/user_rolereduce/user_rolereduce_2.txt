
mysql> select * from bs_user_role where user_id=8;
+----+---------+---------+--------+------------+---------------------+---------------------+
| id | user_id | role_id | status | creator_id | created_at          | updated_at          |
+----+---------+---------+--------+------------+---------------------+---------------------+
| 16 |       8 |      10 |      1 |          2 | 2020-05-25 14:53:23 | 2020-05-25 15:40:57 |
| 18 |       8 |      11 |      1 |          2 | 2020-05-25 15:27:46 | 2020-05-25 15:40:57 |
+----+---------+---------+--------+------------+---------------------+---------------------+
2 rows in set (0.00 sec)

mysql>



2 user1
b363f618c95e01c4ed8cb2732676533d
{
    "user_id":8,
    "role_ids":[9,10]
}
{
    "code": 0,
    "msg": "SUCCESS"
}


{"level":"debug","msg":"sign before: POST127.0.0.1:3000/api/v1/user/rolereduce{\"role_ids\":[9,10],\"user_id\":8}1234567890com.obencn.secondchase.3671e28d-e384-49e6-9cea-4d8cb80288d4","source":"head.go:116:middleware.Options","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"server sign: b363f618c95e01c4ed8cb2732676533d, \tuser sign: b363f618c95e01c4ed8cb2732676533d","source":"context.go:161:gin.(*Context).Next","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"request uri=/api/v1/user/rolereduce JWT 验证token","source":"context.go:161:gin.(*Context).Next","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"request token=eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWNvbmRjaGFzZS5nYXRld2F5Iiwic3ViIjoiQWNjZXNzVG9rZW4iLCJhdWQiOiJodHRwczovL2JhY2tzdGFnZS5vYmVuY24uY29tIiwiZXhwIjoxNTkwNDc0OTcxLCJuYmYiOjE1OTAzODgyNzEsImlhdCI6MTU5MDM4ODU3MSwianRpIjoiOGVkN2Y3ZDYtYmFiMS00ODk4LThiNzYtYjQ4NmU3NmQ0MGE4IiwidXNlcl9pZCI6Mn0.jIfSxR5mthmB_TV3MXBnXVLEYSrFwS1p2tTo6ZdZ664","source":"context.go:161:gin.(*Context).Next","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"request uri=/api/v1/user/rolereduce middleware Casbin 验证权限","source":"context.go:161:gin.(*Context).Next","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"userService RoleReduce req={UserId:8 RoleIds:[9 10]}","source":"user.go:327:handler.(*userHandler).RoleReduce.func1","time":"2020-05-25T17:24:26+08:00"}
2020/05/25 17:24:26 Request: 2, /api/v1/user/rolereduce, POST ---> true
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user_role.go:6221.2199msSELECT * FROM `bs_user_role`  WHERE (status=? AND user_id=?)[1 8] 2","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"userService RoleReduce 待减少角色的用户 userId=8 可用角色列表 mUserNormalRoles=map[10:{} 11:{}]","source":"user.go:327:handler.(*userHandler).RoleReduce.func1","time":"2020-05-25T17:24:26+08:00"}
{"level":"debug","msg":"userService RoleReduce 待减少角色的用户 userId=8 可减少角色列表 mUserCanReduceRoleIds=map[10:{}]","source":"user.go:327:handler.(*userHandler).RoleReduce.func1","time":"2020-05-25T17:24:26+08:00"}
{"level":"info","msg":"sqlC:/oben/project/backstage/repository/user_role.go:3623.8783msUPDATE `bs_user_role` SET `user_id` = ?, `role_id` = ?, `status` = ?, `creator_id` = ?, `updated_at` = ?  WHERE `bs_user_role`.`id` = ?[8 10 0 2 2020-05-25 17:24:26.6112615 +0800 CST m=+483.807668701 16] 1","source":"scope.go:1047:gorm.(*Scope).trace","time":"2020-05-25T17:24:26+08:00"}



mysql> select * from bs_user_role where user_id=8;
+----+---------+---------+--------+------------+---------------------+---------------------+
| id | user_id | role_id | status | creator_id | created_at          | updated_at          |
+----+---------+---------+--------+------------+---------------------+---------------------+
| 16 |       8 |      10 |      0 |          2 | 2020-05-25 14:53:23 | 2020-05-25 17:24:27 |
| 18 |       8 |      11 |      1 |          2 | 2020-05-25 15:27:46 | 2020-05-25 15:40:57 |
+----+---------+---------+--------+------------+---------------------+---------------------+
2 rows in set (0.00 sec)
mysql>


userService RoleReduce req={UserId:8 RoleIds:[9 10]}
2020/05/25 17:24:26 Request: 2, /api/v1/user/rolereduce, POST ---> true

SELECT * FROM `bs_user_role`  WHERE (status=? AND user_id=?)[1 8] 2
userService RoleReduce 待减少角色的用户 userId=8 可用角色列表 mUserNormalRoles=map[10:{} 11:{}]
userService RoleReduce 待减少角色的用户 userId=8 可减少角色列表 mUserCanReduceRoleIds=map[10:{}]

UPDATE `bs_user_role` SET `user_id` = ?, `role_id` = ?, `status` = ?, `creator_id` = ?, `updated_at` = ?  WHERE `bs_user_role`.`id` = ?
[8 10 0 2 2020-05-25 17:24:26.6112615 +0800 CST m=+483.807668701 16] 1
